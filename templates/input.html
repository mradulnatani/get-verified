<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload CSV & Image</title>
  <style>
    :root{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{display:flex;min-height:100vh;align-items:center;justify-content:center;padding:24px;background:#f6f8fb}
    .card{width:100%;max-width:860px;background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(28,39,63,0.08);padding:22px}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 18px;color:#58667a}
    .row{display:flex;gap:18px}
    .col{flex:1}
    .drop{border:2px dashed #dbe4f0;border-radius:10px;padding:18px;text-align:center;cursor:pointer;transition:all .15s}
    .drop.dragover{background:#f0f6ff;border-color:#7aa2ff}
    input[type=file]{display:none}
    button{background:#2b6ef6;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .preview{margin-top:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    table th,table td{border:1px solid #e6edf3;padding:6px;text-align:left}
    .hint{font-size:13px;color:#6b7280;margin-top:8px}
    .actions{display:flex;gap:8px;align-items:center;margin-top:14px}
    .small{font-size:13px;color:#334155}
  </style>
</head>
<body>
  <div class="card">
    <h1>Upload a CSV file and an Image</h1>
    <p class="lead">Select or drag & drop a CSV file (text/csv) and an image. Previews are shown below. The form is configured for server upload (multipart/form-data).</p>

    <form id="uploadForm" method="POST" action="/upload" enctype="multipart/form-data">
      <div class="row">
        <div class="col">
          <label class="small">CSV file</label>
          <div id="csvDrop" class="drop" tabindex="0">
            <div>Drag & drop a CSV here, or <button type="button" id="csvBrowseBtn">Browse</button></div>
            <div class="hint">Accepted: .csv — Max recommended size: 5 MB</div>
            <input id="csvInput" type="file" name="data_csv" accept="text/csv,application/vnd.ms-excel" />
          </div>
          <div id="csvPreview" class="preview"></div>
        </div>

        <div class="col">
          <label class="small">Image file</label>
          <div id="imgDrop" class="drop" tabindex="0">
            <div>Drag & drop an image here, or <button type="button" id="imgBrowseBtn">Browse</button></div>
            <div class="hint">Accepted: png, jpg, jpeg, gif — Max recommended size: 5 MB</div>
            <input id="imgInput" type="file" name="image_file" accept="image/*" />
          </div>
          <div id="imgPreview" class="preview"></div>
        </div>
      </div>

      <div class="actions">
        <button type="submit">Upload to server</button>
        <button type="button" id="downloadJson">Download parsed CSV (JSON)</button>
        <div class="small">Preview is client-side only — files are not sent until you press "Upload to server".</div>
      </div>
    </form>
  </div>

  <script>
    // Helpers
    const csvInput = document.getElementById('csvInput');
    const imgInput = document.getElementById('imgInput');
    const csvDrop = document.getElementById('csvDrop');
    const imgDrop = document.getElementById('imgDrop');
    const csvPreview = document.getElementById('csvPreview');
    const imgPreview = document.getElementById('imgPreview');
    const csvBrowseBtn = document.getElementById('csvBrowseBtn');
    const imgBrowseBtn = document.getElementById('imgBrowseBtn');
    const downloadJsonBtn = document.getElementById('downloadJson');

    // Small CSV parser (handles simple CSVs; not a full RFC4180 implementation)
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      if(lines.length===0) return {headers:[], rows:[]};
      const headers = splitCSVLine(lines[0]);
      const rows = lines.slice(1).map(l => {
        const cols = splitCSVLine(l);
        const obj = {};
        headers.forEach((h,i)=> obj[h ?? `col${i+1}`] = cols[i] ?? '');
        return obj;
      });
      return {headers, rows};
    }

    function splitCSVLine(line){
      const result=[]; let cur=''; let inQuote=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){
          if(inQuote && line[i+1]==='"'){ cur+='"'; i++; } else { inQuote = !inQuote; }
        } else if(ch===',' && !inQuote){ result.push(cur); cur=''; } else { cur+=ch; }
      }
      result.push(cur);
      return result;
    }

    // File handling
    function handleCSVFile(file){
      if(!file) return;
      if(!file.type.includes('csv') && !file.name.endsWith('.csv')){
        csvPreview.innerHTML = '<div style="color:#b91c1c">Please upload a valid CSV file.</div>';
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        try{
          const parsed = parseCSV(e.target.result);
          renderCSVPreview(parsed);
          csvPreview._parsed = parsed; // store
        }catch(err){ csvPreview.innerHTML = '<div style="color:#b91c1c">Error parsing CSV.</div>'; }
      };
      reader.readAsText(file);
    }

    function handleImageFile(file){
      if(!file) return;
      if(!file.type.startsWith('image/')){
        imgPreview.innerHTML = '<div style="color:#b91c1c">Please upload an image file.</div>';
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        imgPreview.innerHTML = `<img src="${e.target.result}" alt="preview" style="max-width:100%;max-height:260px;border-radius:8px;box-shadow:0 6px 12px rgba(15,23,42,0.06)"/>`;
      };
      reader.readAsDataURL(file);
    }

    function renderCSVPreview(parsed){
      if(parsed.headers.length===0){ csvPreview.innerHTML = '<div class="small">Empty CSV</div>'; return; }
      // show first 8 rows
      const rows = parsed.rows.slice(0,8);
      let html = '<div style="overflow:auto;max-height:260px">';
      html += '<table><thead><tr>' + parsed.headers.map(h=>`<th>${escapeHtml(h)}</th>`).join('') + '</tr></thead>';
      html += '<tbody>' + rows.map(r=>'<tr>' + parsed.headers.map(h=>`<td>${escapeHtml(String(r[h] ?? ''))}</td>`).join('') + '</tr>').join('') + '</tbody></table>';
      html += `<div class="hint">Showing ${rows.length} of ${parsed.rows.length} rows</div>`;
      html += '</div>';
      csvPreview.innerHTML = html;
    }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // Drag & drop utilities
    function setupDrop(dropEl, inputEl, onFile){
      ['dragenter','dragover'].forEach(ev => dropEl.addEventListener(ev,e=>{ e.preventDefault(); dropEl.classList.add('dragover'); }));
      ['dragleave','drop'].forEach(ev => dropEl.addEventListener(ev,e=>{ e.preventDefault(); dropEl.classList.remove('dragover'); }));
      dropEl.addEventListener('drop', e=>{
        const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f){ inputEl.files = e.dataTransfer.files; onFile(f);} 
      });
      dropEl.addEventListener('click', ()=> inputEl.click());
      inputEl.addEventListener('change', ()=> onFile(inputEl.files && inputEl.files[0]));
      // keyboard: Enter to open
      dropEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') inputEl.click(); });
    }

    setupDrop(csvDrop, csvInput, handleCSVFile);
    setupDrop(imgDrop, imgInput, handleImageFile);

    csvBrowseBtn.addEventListener('click', ()=> csvInput.click());
    imgBrowseBtn.addEventListener('click', ()=> imgInput.click());

    downloadJsonBtn.addEventListener('click', ()=>{
      const parsed = csvPreview._parsed;
      if(!parsed) return alert('No parsed CSV available.');
      const blob = new Blob([JSON.stringify(parsed.rows, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'csv-as-json.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Basic client-side validation before submit
    document.getElementById('uploadForm').addEventListener('submit', (e)=>{
      const csvFile = csvInput.files && csvInput.files[0];
      const imgFile = imgInput.files && imgInput.files[0];
      if(!csvFile && !imgFile){ e.preventDefault(); alert('Please select at least one file (CSV or Image) to upload.'); return; }
      // allow submission; server should validate as well
    });
  </script>
</body>
</html>

