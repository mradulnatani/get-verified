<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Template Editor</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
#sidebar { float: left; width: 250px; }
#canvas-wrap { margin-left: 270px; }
#canvas-container { position: relative; border: 1px solid #ddd; display:inline-block; }
#main-image { display:block; max-width:800px; max-height:800px; }
.var-tag { padding:6px; background:#eef; margin:6px; cursor:grab; border:1px solid #99c;}
.placed { position:absolute; pointer-events:auto; background:transparent; font-weight:bold; color:#b22222; }
.controls { margin-top: 16px; }
#preview-btn { margin-top: 10px; }
</style>
</head>
<body>

<h2>Template Editor</h2>

<div id="sidebar">
    <h3>CSV Columns</h3>
    <div id="columns">
      {% for col in columns %}
        <div class="var-tag" draggable="true" data-col="{{ col }}">{{ col }}</div>
      {% endfor %}
    </div>

    <div class="controls">
        <input type="hidden" id="csv_file" value="{{ csv_file }}"> <!-- FIXED CSV input -->

        <label>Font size:&nbsp;
            <input id="fontSize" type="number" value="32" min="8" max="200">
        </label>
        <br><br>
        <label>Color:&nbsp;<input id="fontColor" type="color" value="#000000"></label>
        <br><br>
        <button id="saveTemplate">Save Template</button>
        <button id="generate">Generate & Email</button>
        <button id="preview-btn">Preview Generated Images</button>
        <div id="status" style="margin-top:8px;color:green"></div>
    </div>
</div>

<div id="canvas-wrap">
    <div id="canvas-container" ondrop="drop(event)" ondragover="allowDrop(event)">
        <img id="main-image" src="/uploads/{{ image }}" alt="base">
    </div>
</div>

<script>
let draggingCol = null;
let placed = [];
let savedTemplateName = null;

// Drag start
document.querySelectorAll('.var-tag').forEach(el=>{
  el.addEventListener('dragstart', (ev)=>{
    draggingCol = el.dataset.col;
    ev.dataTransfer.setData("text/plain", draggingCol);
  });
});

// Allow drop
function allowDrop(ev){ ev.preventDefault(); }

function drop(ev){
  ev.preventDefault();
  const colName = ev.dataTransfer.getData("text/plain");
  if(!colName) return;

  const img = document.getElementById('main-image');
  const rect = img.getBoundingClientRect();
  const x = ev.clientX - rect.left;
  const y = ev.clientY - rect.top;
  const nx = x / rect.width;
  const ny = y / rect.height;

  const fontSize = parseInt(document.getElementById('fontSize').value || "32");
  const color = document.getElementById('fontColor').value || "#000000";

  const tag = document.createElement('div');
  tag.className = 'placed';
  tag.style.left = (nx*100) + "%";
  tag.style.top = (ny*100) + "%";
  tag.style.fontSize = fontSize + "px";
  tag.style.color = color;
  tag.textContent = colName;
  tag.dataset.col = colName;
  tag.dataset.nx = nx;
  tag.dataset.ny = ny;
  tag.dataset.font = fontSize;
  tag.dataset.color = color;

  makeDraggable(tag);
  document.getElementById('canvas-container').appendChild(tag);

  placed.push({ col: colName, x: nx, y: ny, font_size: fontSize, color: color });
}

// Draggable placed elements
function makeDraggable(el){
  let isDown=false, startX=0, startY=0, origLeft=0, origTop=0;
  el.addEventListener('mousedown', (e)=>{
    isDown=true; startX=e.clientX; startY=e.clientY;
    const rect = el.getBoundingClientRect();
    origLeft = rect.left; origTop = rect.top;
    e.preventDefault();
  });
  document.addEventListener('mousemove', (e)=>{
    if(!isDown) return;
    const img = document.getElementById('main-image');
    const rect = img.getBoundingClientRect();
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    let newLeft = origLeft + dx - rect.left;
    let newTop = origTop + dy - rect.top;
    newLeft = Math.max(0, Math.min(newLeft, rect.width));
    newTop = Math.max(0, Math.min(newTop, rect.height));
    el.style.left = (newLeft / rect.width * 100) + "%";
    el.style.top = (newTop / rect.height * 100) + "%";
  });
  document.addEventListener('mouseup', ()=>{
    if(!isDown) return;
    isDown=false;
    const img = document.getElementById('main-image');
    const rect = img.getBoundingClientRect();
    const left = parseFloat(el.style.left)/100 * rect.width;
    const top = parseFloat(el.style.top)/100 * rect.height;
    const nx = left / rect.width;
    const ny = top / rect.height;
    const col = el.dataset.col;
    for(let i=placed.length-1;i>=0;i--){
      if(placed[i].col === col){
        placed[i].x = nx;
        placed[i].y = ny;
        placed[i].font_size = parseInt(el.dataset.font || el.style.fontSize) || placed[i].font_size;
        placed[i].color = el.dataset.color || placed[i].color;
        break;
      }
    }
  });
}

// Save template
document.getElementById('saveTemplate').addEventListener('click', async ()=>{
  const domPlaced = Array.from(document.querySelectorAll('.placed'));
  const placements = domPlaced.map(d=>{
    return {
      col: d.dataset.col,
      x: parseFloat(d.style.left)/100,
      y: parseFloat(d.style.top)/100,
      font_size: parseInt(window.getComputedStyle(d).fontSize)||32,
      color: d.style.color || "#000000"
    };
  });

  const payload = {
    image: "{{ image }}",
    csv: document.getElementById("csv_file").value,  // <-- FIXED
    placements: placements
  };

  const res = await fetch('/save_template_new', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  const data = await res.json();
  if(data.template_name){
    savedTemplateName = data.template_name;
    document.getElementById('status').textContent = "Template saved: " + savedTemplateName;
  } else {
    document.getElementById('status').textContent = "Error saving template.";
  }
});

// Generate & Email
document.getElementById('generate').addEventListener('click', async ()=>{
  if(!savedTemplateName){ alert("Save template first!"); return; }
  const form = new FormData();
  form.append('template_name', savedTemplateName);
  form.append('send_email', 'true');

  const res = await fetch('/process_batch', { method:'POST', body:form });
  const j = await res.json();
  if(j.status==="ok"){
    document.getElementById('status').textContent = 'Generated images for all rows.';
  } else {
    document.getElementById('status').textContent = 'Error generating images: '+(j.message||'Unknown');
  }
});

// Preview
document.getElementById('preview-btn').addEventListener('click', ()=>{
  if(!savedTemplateName){ alert("Save template first!"); return; }
  window.open("/preview/" + encodeURIComponent(savedTemplateName), "_blank");
});
</script>

</body>
</html>

